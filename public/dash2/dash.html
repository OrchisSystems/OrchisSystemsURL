<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../js/sessao.js"></script>
    <script></script>
    <link rel="stylesheet" href="./estilo.css">
    <title>Dash2</title>
</head>

<body onload="validarSessao()">
    <header>
        <a onclick="abrirMenu()"><img src="./imagens/Menu.png" alt=""></a>
        <img src="./imagens/logo.png" alt="">
        <div id="usuario"></div>
    </header>
    <nav id="menuLateral">
        <a onclick="fecharMenu()"><img src="./imagens/logoMenuLateral.png" alt=""></a>
        <a onclick="adicionarEstufa()"><button>Adicionar Estufa <b>+</b></button></a>
    </nav>
    <center>
        <h1>Estufas</h1>
        <a href="../dashboard/dashboard.html">
            <div id="estufas">
                <div id="cadaEstufa">
                    <h2>Estufa 1</h2>
                    <div id="conteudoEstufa">
                        Local: XXX <br>
                        Status: Muito bom <br>
                        <img src="./imagens/estufaMuitoBom.png" alt="">
                    </div>
                </div>
            </div>
        </a>

    </center>
</body>

</html>

<script>
    var fkEmpresa = sessionStorage.ID_USUARIO
    var valorMaximoEtileno = 0
    var valorMaximoLuminosidade = 0
    var listaIds = []
    var metricaEtileno = 0
    var metricaLuminosidade = 0
    var qtdEstufas = 0


    async function adicionarEstufa() {
        pegarIdsEstufas(fkEmpresa);
        await pegarQuantidadeEstufas(fkEmpresa);

        for (index = 0; index < listaIds.length; index++){
            await pegarMaximoEtileno(listaIds[index]);
            await pegarMaximoLuminosidade(listaIds[index]);
            await pegarMetricaEstufas(listaIds[index])
            estufas.innerHTML += `<a href="../dashboard/dashboard.html">
            <div id="estufas">
                <div id="cadaEstufa">
                    <h2>Estufa ${listaIds[index]}</h2>
                    <div id="conteudoEstufa">
                        Status: Muito bom <br>
                        <img src="./imagens/estufaMuitoBom.png" alt="">
                    </div>
                </div>
            </div>
        </a>`
        }
        
    }

    function abrirMenu() {
        menuLateral.style.width = '250px'
    }
    function fecharMenu() {
        menuLateral.style.width = '0px'
    }

    async function pegarMaximoEtileno(idEstufa){
        await fetch("/coletaSensor/pegarMaximoEtileno", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
          idEstufaServer: idEstufa
        })
        }).then(function (resposta) {
            console.log("Peguei o maior valor de etileno")

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    
                    valorMaximoEtileno = json[0].Etileno
                    

                });

            } else {

                console.log("Houve um erro ao pegar o maximo do etileno!");

                resposta.text().then(texto => {
                    console.error(texto);
                    finalizarAguardar(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })
        }

    async function pegarMaximoLuminosidade(idEstufa){
        await fetch("/coletaSensor/pegarMaximoLuminosidade", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
          idEstufaServer: idEstufa
        })
        }).then(function (resposta) {
            console.log("Peguei o dado maximo de luminosidade")

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    
                    valorMaximoLuminosidade = json[0].Luminosidade
                    

                });

            } else {

                console.log("Houve um erro ao pegar o maximo da luminosidade");

                resposta.text().then(texto => {
                    console.error(texto);
                    finalizarAguardar(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })
        }

        async function pegarIdsEstufas(fkEmpresa){
            await fetch("/coletaSensor/pegarIdsEstufas", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkEmpresaServer: fkEmpresa
            })
            }).then(function (resposta) {
                console.log("Peguei os dados dos Ids das estufas!")

                if (resposta.ok) {
                    console.log(resposta);

                    resposta.json().then(json => {
                        console.log(json);
                        
                        for (i = 0; i < json.length; i++)
                        listaIds.push([json[i].idEstufa])
                        

                    });

                } else {

                    console.log("Houve um erro ao pegas os Ids das estufas!");

                    resposta.text().then(texto => {
                        console.error(texto);
                        finalizarAguardar(texto);
                    });
                }

            }).catch(function (erro) {
                console.log(erro);
            })
        }
        
        async function pegarMetricaEstufas(idEstufa){
            await fetch("/coletaSensor/pegarMetricasEstufa", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
          idEstufaServer: idEstufa
        })
        }).then(function (resposta) {
            console.log("Peguei as métricas da estufa")

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    metricaEtileno = json[0].Etileno
                    metricaLuminosidade = json[0].Luminosidade

                });

            } else {

                console.log("Houve um erro ao pegar as métricas");

                resposta.text().then(texto => {
                    console.error(texto);
                    finalizarAguardar(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })
        }
        
        async function pegarQuantidadeEstufas(fkEmpresa){
            await fetch("/coletaSensor/pegarQuantidadeEstufas", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
          fkEmpresaServer: fkEmpresa
        })
        }).then(function (resposta) {
            console.log("Peguei as métricas da estufa")

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    qtdEstufas = json[0].quantidade

                });

            } else {

                console.log("Houve um erro ao pegar as métricas");

                resposta.text().then(texto => {
                    console.error(texto);
                    finalizarAguardar(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })
        }

</script>